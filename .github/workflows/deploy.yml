name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_PATH: /opt/proctorwise

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 30m
          script: |
            echo "Starting deployment..."

            cd ${{ env.PROJECT_PATH }}

            # Pull latest code
            git fetch origin main
            git reset --hard origin/main

            # Update PUBLIC_HOST in .env with VPS IP
            PUBLIC_IP=$(curl -s ifconfig.me || echo "${{ secrets.VPS_HOST }}")
            sed -i "s/PUBLIC_HOST=.*/PUBLIC_HOST=$PUBLIC_IP/" .env

            # Generate self-signed SSL certificate if missing
            SSL_DIR="${{ env.PROJECT_PATH }}/docker/ssl"
            mkdir -p "$SSL_DIR"
            if [ ! -f "$SSL_DIR/cert.pem" ]; then
              openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                -keyout "$SSL_DIR/key.pem" -out "$SSL_DIR/cert.pem" \
                -subj "/CN=proctorwise" -addext "subjectAltName=IP:$PUBLIC_IP"
              echo "SSL certificate generated for IP: $PUBLIC_IP"
            fi

            # Build and restart services
            docker compose pull
            docker compose up -d --build

            # Clean up unused images
            docker image prune -f

            # Wait for services to start
            echo "Waiting for services to start..."
            sleep 30
            docker compose ps

            echo "Deployment completed!"

      - name: Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Running health checks..."

            HEALTHY=0
            TOTAL=6

            for port in 8001 8000 8003 8004 8005 8006; do
              if curl -sf --max-time 10 http://localhost:$port/health > /dev/null 2>&1; then
                echo "OK - Port $port"
                HEALTHY=$((HEALTHY + 1))
              else
                echo "FAIL - Port $port"
              fi
            done

            echo "$HEALTHY/$TOTAL services healthy"

            if [ $HEALTHY -lt 4 ]; then
              echo "Too many services down!"
              exit 1
            fi

            echo "Health checks passed!"

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
      - name: Send failure notification
        run: |
          echo "Deployment failed! Check the logs."
