name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:  # Permet de lancer manuellement depuis GitHub

env:
  PROJECT_PATH: /opt/proctorwise

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "üöÄ Starting deployment..."

            # Aller dans le dossier du projet
            cd ${{ env.PROJECT_PATH }}

            # R√©cup√©rer les derni√®res modifications
            git fetch origin main
            git reset --hard origin/main

            # Reconstruire et relancer les containers modifi√©s
            docker compose pull
            docker compose up -d --build

            # Nettoyer les images inutilis√©es
            docker image prune -f

            # V√©rifier que les services sont up
            sleep 10
            docker compose ps

            echo "‚úÖ Deployment completed successfully!"

      - name: Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "üè• Running health checks..."

            # V√©rifier les services principaux
            curl -sf http://localhost:8001/health || echo "‚ö†Ô∏è UserService unhealthy"
            curl -sf http://localhost:8000/health || echo "‚ö†Ô∏è ReservationService unhealthy"
            curl -sf http://localhost:8003/health || echo "‚ö†Ô∏è MonitoringService unhealthy"
            curl -sf http://localhost:8006/health || echo "‚ö†Ô∏è AnalyticsService unhealthy"

            echo "‚úÖ Health checks completed!"

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
      - name: Send failure notification
        run: |
          echo "‚ùå Deployment failed! Check the logs."
          # Tu peux ajouter ici un webhook Discord/Slack si tu veux
