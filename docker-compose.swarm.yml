version: "3.8"

# =============================================================================
# ProctorWise - Docker Swarm Configuration
# =============================================================================
# Deploy with: docker stack deploy -c docker-compose.swarm.yml proctorwise
# =============================================================================

services:
  # ===========================================================================
  # INFRASTRUCTURE
  # ===========================================================================

  mariadb:
    image: mariadb:10.11
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root_secret}
      MYSQL_USER: ${DB_USER:-proctorwise}
      MYSQL_PASSWORD: ${DB_PASSWORD:-proctorwise_secret}
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./docker/mariadb/init:/docker-entrypoint-initdb.d:ro
    networks:
      - proctorwise
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
    networks:
      - proctorwise
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - proctorwise
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # ===========================================================================
  # APPLICATION SERVICES
  # ===========================================================================

  userservice:
    image: ${REGISTRY:-}proctorwise-userservice:${TAG:-latest}
    environment:
      DATABASE_URL: mysql+pymysql://${DB_USER:-proctorwise}:${DB_PASSWORD:-proctorwise_secret}@mariadb:3306/proctorwise_users
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-change_me_in_production}
    networks:
      - proctorwise
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 5s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.userservice.rule=PathPrefix(`/users`) || PathPrefix(`/auth`)"
        - "traefik.http.services.userservice.loadbalancer.server.port=8000"

  reservationservice:
    image: ${REGISTRY:-}proctorwise-reservationservice:${TAG:-latest}
    environment:
      DATABASE_URL: mysql+pymysql://${DB_USER:-proctorwise}:${DB_PASSWORD:-proctorwise_secret}@mariadb:3306/proctorwise_reservations
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    networks:
      - proctorwise
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 5s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  monitoringservice:
    image: ${REGISTRY:-}proctorwise-monitoringservice:${TAG:-latest}
    environment:
      DATABASE_URL: mysql+pymysql://${DB_USER:-proctorwise}:${DB_PASSWORD:-proctorwise_secret}@mariadb:3306/proctorwise_monitoring
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    volumes:
      - monitoring_frames:/app/local_storage
    networks:
      - proctorwise
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 5s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  correctionservice:
    image: ${REGISTRY:-}proctorwise-correctionservice:${TAG:-latest}
    environment:
      DATABASE_URL: mysql+pymysql://${DB_USER:-proctorwise}:${DB_PASSWORD:-proctorwise_secret}@mariadb:3306/proctorwise_corrections
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    networks:
      - proctorwise
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 5s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  notificationservice:
    image: ${REGISTRY:-}proctorwise-notificationservice:${TAG:-latest}
    environment:
      DATABASE_URL: mysql+pymysql://${DB_USER:-proctorwise}:${DB_PASSWORD:-proctorwise_secret}@mariadb:3306/proctorwise_notifications
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SMTP_HOST: ${SMTP_HOST:-mailhog}
      SMTP_PORT: ${SMTP_PORT:-1025}
      ENABLE_KAFKA_CONSUMER: "true"
      USER_SERVICE_URL: http://userservice:8000
      RESERVATION_SERVICE_URL: http://reservationservice:8000
    networks:
      - proctorwise
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 5s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  analyticsservice:
    image: ${REGISTRY:-}proctorwise-analyticsservice:${TAG:-latest}
    environment:
      DATABASE_URL: mysql+pymysql://${DB_USER:-proctorwise}:${DB_PASSWORD:-proctorwise_secret}@mariadb:3306/proctorwise_analytics
      USER_SERVICE_URL: http://userservice:8000
      RESERVATION_SERVICE_URL: http://reservationservice:8000
      CORRECTION_SERVICE_URL: http://correctionservice:8000
      MONITORING_SERVICE_URL: http://monitoringservice:8000
    networks:
      - proctorwise
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # ===========================================================================
  # REVERSE PROXY / LOAD BALANCER
  # ===========================================================================

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
      - nginx_cache:/var/cache/nginx
    networks:
      - proctorwise
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
      placement:
        constraints:
          - node.role == manager

# =============================================================================
# NETWORKS
# =============================================================================

networks:
  proctorwise:
    driver: overlay
    attachable: true

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  mariadb_data:
  zookeeper_data:
  kafka_data:
  monitoring_frames:
  nginx_cache:
